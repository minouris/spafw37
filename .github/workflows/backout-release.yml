name: Backout Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to backout (e.g., 1.0.0)'
        required: true
        type: string
      reason:
        description: 'Reason for backout'
        required: false
        type: string
        default: 'Release backout'

jobs:
  backout:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate version format
      run: |
        VERSION="${{ inputs.version }}"
        if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        echo "Version format validated: $VERSION"

    - name: Check for unmerged commits on release branches
      run: |
        VERSION="${{ inputs.version }}"
        TAG="v${VERSION}"
        RELEASE_BRANCH="release/${TAG}"
        
        # Parse version for bugfix branch
        IFS='.' read -r major minor patch <<< "$VERSION"
        BUGFIX_BRANCH="bugfix/${major}.${minor}.x"
        
        echo "Checking for unmerged commits..."
        
        # Check release branch
        if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
          git fetch origin "$RELEASE_BRANCH"
          
          # Check if there are commits on release branch not in main
          UNMERGED=$(git log origin/main..origin/$RELEASE_BRANCH --oneline)
          
          if [ -n "$UNMERGED" ]; then
            echo "âŒ Error: Release branch $RELEASE_BRANCH has unmerged commits:"
            echo "$UNMERGED"
            echo ""
            echo "Please merge these commits to main before backing out the release."
            exit 1
          else
            echo "âœ… Release branch has no unmerged commits"
          fi
        else
          echo "Release branch does not exist"
        fi
        
        # Check bugfix branch
        if git ls-remote --heads origin "$BUGFIX_BRANCH" | grep -q "$BUGFIX_BRANCH"; then
          git fetch origin "$BUGFIX_BRANCH"
          
          # Check if there are commits on bugfix branch not in main
          UNMERGED=$(git log origin/main..origin/$BUGFIX_BRANCH --oneline)
          
          if [ -n "$UNMERGED" ]; then
            echo "âŒ Error: Bugfix branch $BUGFIX_BRANCH has unmerged commits:"
            echo "$UNMERGED"
            echo ""
            echo "Please merge these commits to main before backing out the release."
            exit 1
          else
            echo "âœ… Bugfix branch has no unmerged commits"
          fi
        else
          echo "Bugfix branch does not exist"
        fi

    - name: Check if tag exists
      id: check_tag
      run: |
        TAG="v${{ inputs.version }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG does not exist"
        fi

    - name: Delete GitHub Release
      if: steps.check_tag.outputs.exists == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="v${{ inputs.version }}"
        
        # Try to delete the GitHub Release (may not exist)
        gh release delete "$TAG" --yes || echo "No GitHub Release found for $TAG"

    - name: Delete git tag
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        TAG="v${{ inputs.version }}"
        
        # Delete local tag
        git tag -d "$TAG" || echo "Local tag already deleted"
        
        # Delete remote tag
        git push origin ":refs/tags/$TAG" || echo "Remote tag already deleted"
        
        echo "âœ… Deleted tag: $TAG"

    - name: Delete bugfix branch
      run: |
        VERSION="${{ inputs.version }}"
        
        # Parse version components
        IFS='.' read -r major minor patch <<< "$VERSION"
        BUGFIX_BRANCH="bugfix/${major}.${minor}.x"
        
        # Check if bugfix branch exists
        if git ls-remote --heads origin "$BUGFIX_BRANCH" | grep -q "$BUGFIX_BRANCH"; then
          git push origin --delete "$BUGFIX_BRANCH"
          echo "âœ… Deleted bugfix branch: $BUGFIX_BRANCH"
        else
          echo "Bugfix branch $BUGFIX_BRANCH does not exist"
        fi

    - name: Delete release branch
      run: |
        TAG="v${{ inputs.version }}"
        BRANCH_NAME="release/${TAG}"
        
        # Check if branch exists
        if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
          git push origin --delete "$BRANCH_NAME"
          echo "âœ… Deleted release branch: $BRANCH_NAME"
        else
          echo "Release branch $BRANCH_NAME does not exist"
        fi

    - name: Update main branch version
      run: |
        VERSION="${{ inputs.version }}"
        
        # Checkout main
        git checkout main
        git pull origin main
        
        # Set version back to the release version with .dev0 suffix
        DEV_VERSION="${VERSION}.dev0"
        
        sed -i "s/^version = .*/version = $DEV_VERSION/" setup.cfg
        
        git add setup.cfg
        git commit -m "Backout release v$VERSION: Reset to $DEV_VERSION [skip ci]" \
                   -m "Reason: ${{ inputs.reason }}"
        git push origin main
        
        echo "âœ… Reset main branch version to: $DEV_VERSION"

    - name: Summary
      run: |
        VERSION="${{ inputs.version }}"
        IFS='.' read -r major minor patch <<< "$VERSION"
        
        echo "## Backout Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** v$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Actions Taken:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deleted GitHub Release (if existed)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deleted git tag v$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deleted release branch release/v$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deleted bugfix branch bugfix/${major}.${minor}.x" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Reset main branch version to ${VERSION}.dev0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Important Notes:" >> $GITHUB_STEP_SUMMARY
        echo "- âš ï¸ The PyPI package **cannot** be deleted (PyPI policy)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’¡ You can now commit fixes and re-run the release workflow" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’¡ The same version number (v$VERSION) can be re-released" >> $GITHUB_STEP_SUMMARY
