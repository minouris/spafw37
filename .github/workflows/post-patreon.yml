name: Generate Patreon Post Content

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      release_url:
        description: 'GitHub Release URL (optional - will be auto-detected if empty)'
        required: false
        type: string

jobs:
  generate-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Validate version format
      run: |
        VERSION="${{ inputs.version }}"
        if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        echo "Version format validated: $VERSION"

    - name: Get release URL
      id: release_info
      run: |
        VERSION="${{ inputs.version }}"
        TAG="v${VERSION}"
        
        # Use provided URL or fetch from GitHub
        if [ -n "${{ inputs.release_url }}" ]; then
          RELEASE_URL="${{ inputs.release_url }}"
        else
          # Check if release exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          else
            echo "âš ï¸  Warning: Release $TAG not found, using generic URL"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases"
          fi
        fi
        
        echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
        echo "Release URL: $RELEASE_URL"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract changelog
      id: changelog
      run: |
        VERSION="${{ inputs.version }}"
        
        # Try to extract changelog for this version
        if [ -f CHANGELOG.md ]; then
          CHANGELOG_EXCERPT=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +3 || echo "")
          
          if [ -z "$CHANGELOG_EXCERPT" ]; then
            CHANGELOG_EXCERPT="See release notes for details."
          fi
        else
          CHANGELOG_EXCERPT="See release notes for details."
        fi
        
        # Save to file to handle multiline content
        echo "$CHANGELOG_EXCERPT" > /tmp/changelog.txt
        echo "Changelog excerpt extracted"

    - name: Generate post content
      id: post_content
      run: |
        VERSION="${{ inputs.version }}"
        RELEASE_URL="${{ steps.release_info.outputs.release_url }}"
        CHANGELOG_EXCERPT=$(cat /tmp/changelog.txt)
        REPOSITORY="${{ github.repository }}"
        
        # Create post title
        echo "spafw37 v${VERSION} Released" > /tmp/post_title.txt
        
        # Create post content
        {
          echo "ðŸŽ‰ New release of spafw37!"
          echo ""
          echo "This is a lightweight Python 3.7+ framework for building command-line applications. It has configuration management, custom per-command parameters, execution control, repeatable commands, and a whole lot more..."
          echo "It's not very interesting by itself, but it makes developing small apps much easier - it's what I use for my other small tools :)"
          echo ""
          echo "If you use it, please let me know what you think, and if you can think of any features you'd like to see added!"
          echo ""
          echo "If you find any problems, please report them at https://github.com/${REPOSITORY}/issues?q=is%3Aissue+label%3Av${VERSION}"
          echo ""
          echo "Version ${VERSION} is now available on PyPI."
          echo ""
          echo "Install with:"
          echo "\`\`\`"
          echo "pip install spafw37==${VERSION}"
          echo "\`\`\`"
          echo ""
          echo "${CHANGELOG_EXCERPT}"
          echo ""
          echo "ðŸ“¦ View full release notes: ${RELEASE_URL}"
          echo "ðŸ“š Documentation: https://github.com/${REPOSITORY}/tree/v${VERSION}/doc"
          echo "ðŸ PyPI: https://pypi.org/project/spafw37/${VERSION}/"
        } > /tmp/post_content.txt
        
        echo "âœ… Post content generated"

    - name: Display post content
      run: |
        echo "========================================"
        echo "PATREON POST CONTENT"
        echo "========================================"
        echo ""
        echo "TITLE:"
        cat /tmp/post_title.txt
        echo ""
        echo ""
        echo "CONTENT:"
        cat /tmp/post_content.txt
        echo ""
        echo "========================================"

    - name: Summary
      if: always()
      run: |
        POST_TITLE=$(cat /tmp/post_title.txt)
        POST_CONTENT=$(cat /tmp/post_content.txt)
        
        echo "## Patreon Post Content" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Release URL:** ${{ steps.release_info.outputs.release_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Title" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "$POST_TITLE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Content" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "$POST_CONTENT" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Instructions:** Copy the content above and manually post it to [your Patreon page](https://www.patreon.com/posts/create)." >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify PATREON_ACCESS_TOKEN is configured correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Check token has 'w:posts.create' scope" >> $GITHUB_STEP_SUMMARY
          echo "- Verify token hasn't expired" >> $GITHUB_STEP_SUMMARY
        fi
