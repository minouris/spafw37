name: Post Release to Patreon

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      release_url:
        description: 'GitHub Release URL (optional - will be auto-detected if empty)'
        required: false
        type: string

jobs:
  post-to-patreon:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Validate version format
      run: |
        VERSION="${{ inputs.version }}"
        if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        echo "Version format validated: $VERSION"

    - name: Check PATREON_ACCESS_TOKEN
      env:
        PATREON_ACCESS_TOKEN: ${{ secrets.PATREON_ACCESS_TOKEN }}
      run: |
        if [ -z "$PATREON_ACCESS_TOKEN" ]; then
          echo "âŒ Error: PATREON_ACCESS_TOKEN secret is not configured"
          echo "Please add it in Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        echo "âœ… Patreon token is configured"

    - name: Get release URL
      id: release_info
      run: |
        VERSION="${{ inputs.version }}"
        TAG="v${VERSION}"
        
        # Use provided URL or fetch from GitHub
        if [ -n "${{ inputs.release_url }}" ]; then
          RELEASE_URL="${{ inputs.release_url }}"
        else
          # Check if release exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          else
            echo "âš ï¸  Warning: Release $TAG not found, using generic URL"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases"
          fi
        fi
        
        echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
        echo "Release URL: $RELEASE_URL"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract changelog
      id: changelog
      run: |
        VERSION="${{ inputs.version }}"
        
        # Try to extract changelog for this version
        if [ -f CHANGELOG.md ]; then
          CHANGELOG_EXCERPT=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +3 || echo "")
          
          if [ -z "$CHANGELOG_EXCERPT" ]; then
            CHANGELOG_EXCERPT="See release notes for details."
          fi
        else
          CHANGELOG_EXCERPT="See release notes for details."
        fi
        
        # Save to file to handle multiline content
        echo "$CHANGELOG_EXCERPT" > /tmp/changelog.txt
        echo "Changelog excerpt extracted"

    - name: Post to Patreon
      env:
        PATREON_ACCESS_TOKEN: ${{ secrets.PATREON_ACCESS_TOKEN }}
      run: |
        VERSION="${{ inputs.version }}"
        RELEASE_URL="${{ steps.release_info.outputs.release_url }}"
        CHANGELOG_EXCERPT=$(cat /tmp/changelog.txt)
        
        # Create post content
        POST_TITLE="spafw37 v${VERSION} Released"
        POST_CONTENT="ðŸŽ‰ New release of spafw37!

        Version ${VERSION} is now available on PyPI.
        
        Install with:
        \`\`\`
        pip install spafw37==${VERSION}
        \`\`\`
        
        ${CHANGELOG_EXCERPT}
        
        ðŸ“¦ View full release notes: ${RELEASE_URL}
        ðŸ“š Documentation: https://github.com/${{ github.repository }}/tree/v${VERSION}/doc
        ðŸ PyPI: https://pypi.org/project/spafw37/${VERSION}/"
        
        # Post to Patreon API
        echo "Posting release announcement to Patreon..."
        
        RESPONSE=$(curl -s -X POST "https://www.patreon.com/api/oauth2/v2/posts" \
          -H "Authorization: Bearer ${PATREON_ACCESS_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"data\": {
              \"type\": \"post\",
              \"attributes\": {
                \"title\": \"${POST_TITLE}\",
                \"content\": $(echo "$POST_CONTENT" | jq -Rs .),
                \"is_paid\": false,
                \"is_public\": true
              }
            }
          }")
        
        # Check for errors
        if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
          echo "âŒ Error posting to Patreon:"
          echo "$RESPONSE" | jq '.errors'
          exit 1
        else
          POST_URL=$(echo "$RESPONSE" | jq -r '.data.attributes.url // empty')
          if [ -n "$POST_URL" ]; then
            echo "âœ… Successfully posted to Patreon: ${POST_URL}"
            echo "post_url=$POST_URL" >> $GITHUB_OUTPUT
          else
            echo "âœ… Post created on Patreon"
          fi
        fi

    - name: Summary
      if: always()
      run: |
        echo "## Patreon Post" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Release URL:** ${{ steps.release_info.outputs.release_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Successfully posted release announcement to Patreon" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Failed to post to Patreon" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify PATREON_ACCESS_TOKEN is configured correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Check token has 'w:posts.create' scope" >> $GITHUB_STEP_SUMMARY
          echo "- Verify token hasn't expired" >> $GITHUB_STEP_SUMMARY
        fi
