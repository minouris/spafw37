name: Publish to TestPyPI (Dev)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip TestPyPI publish and version bump)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # Required for increment-version workflow to commit

jobs:
  test:
    uses: ./.github/workflows/test.yml
    with:
      python_version: '3.7.9'
      coverage_threshold: 80

  prepare-python:
    needs: test
    uses: ./.github/workflows/build-python.yml
    with:
      python_version: '3.7.9'

  build_and_verify:
    needs: [test, prepare-python]
    uses: ./.github/workflows/build-and-verify.yml
    with:
      python_version: '3.7.9'
      require_sdist: true

  publish:
    needs: [test, prepare-python, build_and_verify]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    env:
      PYTHON_VERSION: '3.7.9'
      PY_PREFIX: ${{ github.workspace }}/.local/python-3.7.9
      PIP_CACHE_DIR: ${{ github.workspace }}/.cache/pip
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        VERSION=$(grep "^version = " setup.cfg | sed 's/version = //')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Ensure cache directories exist
      run: |
        mkdir -p "${{ env.PY_PREFIX }}" "${{ env.PIP_CACHE_DIR }}"

    - name: Restore Python build & pip caches
      id: python-cache
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.PY_PREFIX }}
          ${{ env.PIP_CACHE_DIR }}
        key: python-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          python-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

    - name: Add built Python to PATH
      run: |
        echo "${{ env.PY_PREFIX }}/bin" >> $GITHUB_PATH

    - name: Download built dist artifact
      uses: actions/download-artifact@v3
      with:
        name: dist
        path: dist

    - name: Publish to TestPyPI
      if: ${{ inputs.dry_run != true }}
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        python3 -m pip install --upgrade pip setuptools wheel twine
        ls -la dist || true
        python3 -m twine upload --repository testpypi dist/*

    - name: Dry run - Skip TestPyPI publish
      if: ${{ inputs.dry_run == true }}
      run: |
        echo "[DRY RUN] Skipping TestPyPI publish"
        echo "Would publish the following files:"
        ls -lh dist/

  increment-version:
    needs: publish
    if: ${{ inputs.dry_run != true }}
    uses: ./.github/workflows/increment-version.yml

  dev-release:
    needs: [publish, increment-version]
    if: ${{ inputs.dry_run != true && !cancelled() }}
    uses: ./.github/workflows/milestone-release.yml
    permissions:
      contents: write
    with:
      version: ${{ needs.publish.outputs.version }}
