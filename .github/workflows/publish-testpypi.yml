name: Publish to TestPyPI (Dev)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for increment-version workflow to commit

jobs:
  test:
    uses: ./.github/workflows/test.yml

  publish:
    needs: test
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.7.9'
      PY_PREFIX: ${{ github.workspace }}/.local/python-3.7.9
      PIP_CACHE_DIR: ${{ github.workspace }}/.cache/pip
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Ensure cache directories exist
      run: |
        mkdir -p "${{ env.PY_PREFIX }}" "${{ env.PIP_CACHE_DIR }}"

    - name: Restore Python build & pip caches
      id: python-cache
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.PY_PREFIX }}
          ${{ env.PIP_CACHE_DIR }}
        key: python-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          python-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

    - name: Install build dependencies
      if: steps.python-cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential wget curl libssl-dev zlib1g-dev \
          libbz2-dev libreadline-dev libsqlite3-dev libncurses5-dev libgdbm-dev \
          libnss3-dev liblzma-dev libffi-dev uuid-dev

    - name: Build and install Python (only if cache miss)
      if: steps.python-cache.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        PY=${{ env.PYTHON_VERSION }}
        mkdir -p $HOME/src
        cd $HOME/src
        wget --no-verbose https://www.python.org/ftp/python/${PY}/Python-${PY}.tgz
        tar xzf Python-${PY}.tgz
        cd Python-${PY}
        ./configure --prefix=$PY_PREFIX --with-ensurepip=install
        make -j "$(nproc)"
        make install

    - name: Add built Python to PATH
      run: |
        echo "${{ env.PY_PREFIX }}/bin" >> $GITHUB_PATH

    - name: Verify Python
      run: |
        python3 --version
        python3 -m pip --version

    - name: Install package and build tools
      run: |
        python3 -m pip install --upgrade pip setuptools wheel
        if [ -f requirements.txt ]; then python3 -m pip install -r requirements.txt; fi
        python3 -m pip install -e .
        python3 -m pip install --upgrade build twine

    - name: Install build tools
      run: |
        python3 -m pip install --upgrade build twine

    - name: Build package
      run: |
        python3 -m build

    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        python3 -m twine upload --repository testpypi dist/*

  increment-version:
    needs: publish
    uses: ./.github/workflows/increment-version.yml
